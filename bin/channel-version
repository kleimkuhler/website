#!/bin/bash

if [[ $# -ne 1 ]]; then
    echo "usage: ${0##*/} (edge|stable)" >&2
    exit 1
fi

channel=$1

valid_channels="^(edge|stable)$"
if [[ ! $channel =~ $valid_channels ]]; then
    echo "Valid channels: edge, stable"
    exit 1
fi

tag_name_regex="\"tag_name\": \"$channel-[0-9]+\.[0-9]+\.[0-9]\""
version=$(curl -s https://api.github.com/repos/linkerd/linkerd2/releases | awk -v pattern="$tag_name_regex" '$0 ~ pattern {gsub(/"/, "", $2); gsub(/,$/,""); print $2; exit}')
echo $version
